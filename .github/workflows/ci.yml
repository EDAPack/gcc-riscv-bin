name: CI
on:
  push:
  workflow_dispatch:
  schedule:
    # Every Sunday at 12PM UTC
    - cron: "0 12 * * 0"

jobs:
    version-check:
        runs-on: 'ubuntu-latest'
        outputs:
            gcc_version: ${{ steps.check.outputs.gcc_version }}
            binutils_version: ${{ steps.check.outputs.binutils_version }}
            newlib_version: ${{ steps.check.outputs.newlib_version }}
            rls_version: ${{ steps.check.outputs.rls_version }}
        steps:
        - name: fetch-version
          id: check
          run: |
            # Get latest stable GCC release (14.x series, avoid bleeding edge 15.x)
            gcc_version=$(curl -s https://ftp.gnu.org/gnu/gcc/ | \
                grep -oP 'gcc-14\.\K[0-9]+\.[0-9]+' | \
                sort -V | tail -1)
            gcc_version="14.${gcc_version}"
            
            # Get latest binutils release
            binutils_version=$(curl -s https://ftp.gnu.org/gnu/binutils/ | \
                grep -oP 'binutils-\K[0-9]+\.[0-9]+\.?[0-9]*' | \
                sort -V | tail -1)
            
            # Get latest newlib release (includes date suffix)
            newlib_version=$(curl -s https://sourceware.org/pub/newlib/ | \
                grep -oP 'newlib-\K[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | \
                sort -V | tail -1)

            echo "gcc_version: ${gcc_version}"
            echo "binutils_version: ${binutils_version}"
            echo "newlib_version: ${newlib_version}"

            echo "gcc_version=${gcc_version}" >> ${GITHUB_OUTPUT}
            echo "binutils_version=${binutils_version}" >> ${GITHUB_OUTPUT}
            echo "newlib_version=${newlib_version}" >> ${GITHUB_OUTPUT}

            rls_version="${gcc_version}.${{ github.run_id }}"
            echo "rls_version=${rls_version}" >> ${GITHUB_OUTPUT}

            cat ${GITHUB_OUTPUT}
        - name: print
          run: |
            echo "gcc_version: ${{ steps.check.outputs.gcc_version }}"
            echo "binutils_version: ${{ steps.check.outputs.binutils_version }}"
            echo "newlib_version: ${{ steps.check.outputs.newlib_version }}"
            echo "rls_version: ${{ steps.check.outputs.rls_version }}"


    build-linux-x86_64:
        runs-on: 'ubuntu-latest'
        needs: version-check
        strategy:
          matrix:
            image: [manylinux2014_x86_64, manylinux_2_28_x86_64]
        steps:
            - uses: actions/checkout@v4
            - name: print
              run: |
                echo "image: ${{ matrix.image }}"
                echo "gcc_version: ${{ needs.version-check.outputs.gcc_version }}"
                echo "binutils_version: ${{ needs.version-check.outputs.binutils_version }}"
                echo "newlib_version: ${{ needs.version-check.outputs.newlib_version }}"
            - name: build
              env:
                BUILD_NUM: ${{ github.run_id }}
                image: ${{ matrix.image }}
                gcc_version: ${{ needs.version-check.outputs.gcc_version }}
                binutils_version: ${{ needs.version-check.outputs.binutils_version }}
                newlib_version: ${{ needs.version-check.outputs.newlib_version }}
              run: >
                docker run --rm
                --volume "$(pwd):/io"
                --env BUILD_NUM
                --env gcc_version
                --env binutils_version
                --env newlib_version
                --env image
                --workdir /io
                quay.io/pypa/${{ matrix.image }}
                /io/scripts/build.sh
            - name: upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: "gcc-riscv-${{ matrix.image }}"
                path: "release/gcc-riscv-${{ matrix.image }}-*.tar.gz"
                if-no-files-found: error
                retention-days: 7

    build-linux-arm64:
        runs-on: 'ubuntu-24.04-arm'
        needs: version-check
        strategy:
          matrix:
            image: [manylinux_2_28_aarch64]
        steps:
            - uses: actions/checkout@v4
            - name: print
              run: |
                echo "image: ${{ matrix.image }}"
                echo "gcc_version: ${{ needs.version-check.outputs.gcc_version }}"
                echo "binutils_version: ${{ needs.version-check.outputs.binutils_version }}"
                echo "newlib_version: ${{ needs.version-check.outputs.newlib_version }}"
            - name: build
              env:
                BUILD_NUM: ${{ github.run_id }}
                image: ${{ matrix.image }}
                gcc_version: ${{ needs.version-check.outputs.gcc_version }}
                binutils_version: ${{ needs.version-check.outputs.binutils_version }}
                newlib_version: ${{ needs.version-check.outputs.newlib_version }}
              run: >
                docker run --rm
                --volume "$(pwd):/io"
                --env BUILD_NUM
                --env gcc_version
                --env binutils_version
                --env newlib_version
                --env image
                --workdir /io
                quay.io/pypa/${{ matrix.image }}
                /io/scripts/build.sh
            - name: upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: "gcc-riscv-${{ matrix.image }}"
                path: "release/gcc-riscv-${{ matrix.image }}-*.tar.gz"
                if-no-files-found: error
                retention-days: 7

    publish:
        runs-on: 'ubuntu-latest'
        needs: 
        - build-linux-x86_64
        - build-linux-arm64
        - version-check
        permissions:
            contents: write
        steps:
        - name: Create Release
          id: create_release
          uses: actions/create-release@v1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            tag_name: "v${{ needs.version-check.outputs.rls_version }}"
            release_name: "Release v${{ needs.version-check.outputs.rls_version }}"
            body: |
              RISC-V GCC Bare-Metal Crosscompiler
              GCC Version: ${{ needs.version-check.outputs.gcc_version }}
              Binutils Version: ${{ needs.version-check.outputs.binutils_version }}
              Newlib Version: ${{ needs.version-check.outputs.newlib_version }}
            draft: false
            prerelease: true
        - name: Download build artifacts
          uses: actions/download-artifact@v4
          with:
            pattern: "gcc-riscv-*"
            path: release
            merge-multiple: true

        - name: Upload assets to release
          uses: softprops/action-gh-release@v2
          with:
            tag_name: "v${{ needs.version-check.outputs.rls_version }}"
            files: |
              release/**/*.tar.gz
            fail_on_unmatched_files: true
